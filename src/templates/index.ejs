<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Responsive Admin Dashboard Template" />
    <meta name="keywords" content="admin,dashboard" />
    <meta name="author" content="stacks" />
    <!-- The above 6 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title -->
    <title>Neo - Responsive Admin Dashboard Template</title>

    <!-- Styles -->
    <link
      rel="stylesheet"
      href="plugins/toast-notifications/toast.css"
    />
    <%- include('partials/styles') %>
    <link
      href="plugins/apexcharts/apexcharts.css"
      rel="stylesheet"
    />

    <!-- Theme Styles -->
    <link href="css/main.min.css" rel="stylesheet" />
    <link href="css/custom.css" rel="stylesheet" />

    <script src="plugins/toast-notifications/toast.js" defer></script>
  </head>
  <body class="pace-done no-loader" style>
    <div class="page-container">
      <%- include('partials/page-sidebar') %>
      <div class="modal fade" id="createDashboardModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="createDashboardModalLabel" style="display: none;" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="createDashboardModalTitle">New dashboard</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="close"></button>
            </div>
            <form>
              <div class="modal-body">
                <div class="mb-3">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="floatingDashboardName" placeholder="Dashboard name" required>
                    <label for="floatingDashboardName">Dashboard Name</label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="floatingDescription" placeholder="Description" required>
                    <label for="floatingDescription">Description</label>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Create</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="page-content">
        <div class="page-header">
          <nav class="navbar navbar-expand-lg d-flex justify-content-between">
            <div class="header-title flex-fill">
              <a href="#" id="sidebar-toggle"
                ><i data-feather="arrow-left"></i
              ></a>
              <h5>Dashboard Oe</h5>
            </div>
            <div class="header-search">
              <form>
                <input
                  class="form-control"
                  type="text"
                  placeholder="Type something.."
                  aria-label="Search"
                />
                <a href="#" class="close-search"><i data-feather="x"></i></a>
              </form>
            </div>
            <div class="flex-fill" id="headerNav">
              <ul class="navbar-nav">
                <li class="nav-item d-md-block d-lg-none">
                  <a class="nav-link" href="#" id="toggle-search"
                    ><i data-feather="search"></i
                  ></a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link activity-trigger"
                    href="#"
                    id="activity-sidebar-toggle"
                    ><i data-feather="grid"></i
                  ></a>
                </li>
                <li class="nav-item dropdown">
                  <a
                    class="nav-link notifications-dropdown"
                    href="#"
                    id="notificationsDropDown"
                    role="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    >3
                    <div class="spinner-grow text-danger" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div></a
                  >
                  <div
                    class="dropdown-menu dropdown-menu-end notif-drop-menu"
                    aria-labelledby="notificationsDropDown"
                  >
                    <h6 class="dropdown-header">Notifications</h6>
                    <a href="#">
                      <div class="header-notif">
                        <div class="notif-image">
                          <span class="notification-badge bg-info text-white">
                            <i class="fas fa-bullhorn"></i>
                          </span>
                        </div>
                        <div class="notif-text">
                          <p class="bold-notif-text">
                            faucibus dolor in commodo lectus mattis
                          </p>
                          <small>19:00</small>
                        </div>
                      </div>
                    </a>
                    <a href="#">
                      <div class="header-notif">
                        <div class="notif-image">
                          <span
                            class="notification-badge bg-primary text-white"
                          >
                            <i class="fas fa-bolt"></i>
                          </span>
                        </div>
                        <div class="notif-text">
                          <p class="bold-notif-text">
                            faucibus dolor in commodo lectus mattis
                          </p>
                          <small>18:00</small>
                        </div>
                      </div>
                    </a>
                    <a href="#">
                      <div class="header-notif">
                        <div class="notif-image">
                          <span
                            class="notification-badge bg-success text-white"
                          >
                            <i class="fas fa-at"></i>
                          </span>
                        </div>
                        <div class="notif-text">
                          <p>faucibus dolor in commodo lectus mattis</p>
                          <small>yesterday</small>
                        </div>
                      </div>
                    </a>
                    <a href="#">
                      <div class="header-notif">
                        <div class="notif-image">
                          <span class="notification-badge">
                            <img
                              src="images/avatars/profile-image.png"
                              alt=""
                            />
                          </span>
                        </div>
                        <div class="notif-text">
                          <p>faucibus dolor in commodo lectus mattis</p>
                          <small>yesterday</small>
                        </div>
                      </div>
                    </a>
                    <a href="#">
                      <div class="header-notif">
                        <div class="notif-image">
                          <span class="notification-badge">
                            <img
                              src="images/avatars/profile-image.png"
                              alt=""
                            />
                          </span>
                        </div>
                        <div class="notif-text">
                          <p>faucibus dolor in commodo lectus mattis</p>
                          <small>yesterday</small>
                        </div>
                      </div>
                    </a>
                  </div>
                </li>
                <li class="nav-item dropdown">
                  <a
                    class="nav-link profile-dropdown"
                    href="#"
                    id="profileDropDown"
                    role="button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    ><img
                      src="images/avatars/profile-image.png"
                      alt=""
                  /></a>
                  <div
                    class="dropdown-menu dropdown-menu-end profile-drop-menu"
                    aria-labelledby="profileDropDown"
                  >
                    <a class="dropdown-item" href="#"
                      ><i data-feather="user"></i>Profile</a
                    >
                    <a class="dropdown-item" href="#"
                      ><i data-feather="inbox"></i>Messages</a
                    >
                    <a class="dropdown-item" href="#"
                      ><i data-feather="edit"></i>Activities<span
                        class="badge rounded-pill bg-success"
                        >12</span
                      ></a
                    >
                    <a class="dropdown-item" href="#"
                      ><i data-feather="check-circle"></i>Tasks</a
                    >
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#"
                      ><i data-feather="settings"></i>Settings</a
                    >
                    <a class="dropdown-item" href="#"
                      ><i data-feather="unlock"></i>Lock</a
                    >
                    <button class="dropdown-item" onclick="logout()">
                      <i data-feather="log-out"></i> Logout
                    </button>
                  </div>
                </li>
              </ul>
            </div>
          </nav>
        </div>
        <div class="main-wrapper">
          <div class="row">
              <div class="card main-chart-card">
                <div id="awo" class="card-body b-l text-center">
                  RASI
                  <div class="" id="loading-spinner" style="display:none; margin-top: 5%;">
                    <div class="spinner-border" role="status"></div>
                  </div>
                  <div id="apex3" class="" style="display: none;"></div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="card main-chart-card">
                <div class="card-body b-l text-center">
                  Another chart example
                  <div class="" id="loading-spinner2" style="display:none; margin-top: 5%; text-align: center;">
                    <div class="spinner-border" role="status"></div>
                  </div>
                  <div id="ignore"></div>
                </div>
              </div>
            </div> 
          </div>
          <div class="row">
            <div class="col-lg-4">
              <div class="card card-bg">
                <div class="card-body">
                  <h5 class="card-title">Sales</h5>
                  <button id="oeee" class="btn btn-primary">0</button>
                  <div id="sparkline1"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-bg">
                <div class="card-body">
                  <h5 class="card-title">Visitors</h5>
                  <div id="sparkline2"></div>
                </div>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card card-bg">
                <div class="card-body">
                  <h5 class="card-title">Projects</h5>
                  <div id="sparkline3"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="page-footer">
          <a href="/crypto" class="page-footer-item page-footer-item-right"
            >Crypto<i data-feather="arrow-right" class="footer-right"></i
          ></a>
        </div>
      </div>
    </div>

    <div class="activity-sidebar-overlay"></div>
    <div class="activity-sidebar">
      <a href="#" id="activity-sidebar-close"
        ><i class="material-icons">close</i></a
      >
      <div class="activity-header">
        <h5>Activity Logs</h5>
      </div>
      <div class="activity-body">
        <ul class="activity-list list-unstyled">
          <li class="activity-item">
            <div class="activity-icon"><i class="material-icons">add</i></div>
            <div class="activity-text">
              Ann Green uploaded new item
              <span
                >This item has to be reviewed, moderators will check it
                soon.</span
              >
            </div>
            <div class="activity-helper">45min ago</div>
          </li>
          <li class="activity-item activity-info">
            <div class="activity-icon"><i class="material-icons">code</i></div>
            <div class="activity-text">
              John Doe made changes to create-invoice.js
              <span
                >57 lines of code added, 0 removals, 0 errors, 6 warnings</span
              >
            </div>
            <div class="activity-helper">3h ago</div>
          </li>
          <li class="activity-item activity-danger">
            <div class="activity-icon">
              <i class="material-icons">error_outline</i>
            </div>
            <div class="activity-text">
              Can't retrieve data from server
              <span>Server is not responding, please contact provider</span>
            </div>
            <div class="activity-helper">6h ago</div>
          </li>
          <li class="activity-item">
            <div class="activity-icon"><i class="material-icons">done</i></div>
            <div class="activity-text">
              Files Uploaded
              <span>2 new files uploaded</span>
              <div class="mail-attachment-files">
                <div class="card">
                  <img
                    src="images/card-image.png"
                    class="card-img-top"
                    alt="..."
                  />
                  <div class="card-body">
                    <h5 class="card-title">image.jpg</h5>
                    <p class="card-text text-secondary">305 KB</p>
                  </div>
                </div>
                <div class="card">
                  <img
                    src="images/card-image.png"
                    class="card-img-top"
                    alt="..."
                  />
                  <div class="card-body">
                    <h5 class="card-title">image2.jpg</h5>
                    <p class="card-text text-secondary">400 KB</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="activity-helper">8h ago</div>
          </li>
        </ul>
      </div>
    </div>

    <div class="search-results">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <div class="search-results-header">
              <h5>Search Results</h5>
              <a href="#" id="closeSearch"
                ><i class="material-icons">close</i></a
              >
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4">
            <ul class="search-result-list user-search">
              <li>
                <img
                  src="images/avatars/profile-image.png"
                  alt=""
                />
                <p>
                  John Doe<br />(Works at
                  <span class="search-input-value">hj</span>)
                </p>
              </li>
              <li>
                <img
                  src="images/avatars/profile-image.png"
                  alt=""
                />
                <p>
                  Anna doe<br />(Lives in
                  <span class="search-input-value">hj</span>)
                </p>
              </li>
              <li>
                <img
                  src="images/avatars/profile-image.png"
                  alt=""
                />
                <p>
                  People near:<br /><span class="search-input-value">hj</span>
                </p>
              </li>
            </ul>
          </div>
          <div class="col-md-4">
            <ul class="search-result-list social-search">
              <li>
                <div class="social-search-icon facebook-icon-bg">
                  <i class="fab fa-facebook-f"></i>
                </div>
                <div class="social-search-text">
                  <p><span class="search-input-value">hj</span> on Facebook</p>
                </div>
              </li>
              <li>
                <div class="social-search-icon twitter-icon-bg">
                  <i class="fab fa-twitter"></i>
                </div>
                <div class="social-search-text">
                  <p><span class="search-input-value">hj</span> on Twitter</p>
                </div>
              </li>
              <li>
                <div class="social-search-icon google-icon-bg">
                  <i class="fab fa-google"></i>
                </div>
                <div class="social-search-text">
                  <p><span class="search-input-value">hj</span> on Google</p>
                </div>
              </li>
            </ul>
          </div>
          <div class="col-md-4">
            <ul class="search-result-list article-search">
              <li>
                <p>
                  Lorem ipsum dolor sit amet, consectetur
                  <span class="search-input-value">hj</span> adipiscing elit,
                  sunt in culpa quifdaasd quis.
                </p>
                <span class="search-article-date">06 Jul, 2021</span>
              </li>
              <li>
                <p>
                  Duis non semper sapien. Morbi imperdiet velit in
                  <span class="search-input-value">hj</span> bibendum lobortis.
                  Integer arcu urna, elementum in pellentesque nec, finibus at
                  nisi.
                </p>
                <span class="search-article-date">19 Mar, 2017</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
   
    <div id="toast-container"></div>
    <script src="plugins/apexcharts/apexcharts.min.js"></script>

    <!-- Script para el crear el dashboard -->
    <script>
    function getCookie(name) {
      const value = `${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // Obtener el token CSRF de la cookie
      const csrfToken = getCookie('csrf_access_token');
      
      const form = $("form");
      form.submit((e) => {
        e.preventDefault();
        const dashboardName = $("#floatingDashboardName").val();
        const description = $("#floatingDescription").val();

        fetch('http://127.0.0.1:5000/api/dashboard/create',{
          method: 'POST',
          credentials: 'include',
          headers: {
            "Content-Type": "application/json",
            'X-CSRF-TOKEN': csrfToken
          },
          body: JSON.stringify({
            dashboardName: dashboardName,
            description: description
          })
        }).then(response => {
          if(response.status === 201){
            response.json().then(data => {
              addToast({
                type: "alert-success",
                title: "Ok",
                description: data.msg,
              });
            });
          }else{
            response.json().then(data => {
              addToast({
                type: "alert-danger",
                title: "Error",
                description: data.msg,
              });
            });
          }
        });
        const modal = bootstrap.Modal.getInstance(document.getElementById('createDashboardModal'));
        modal.hide(); 
      })
    </script>

    <!-- Script para las gráficas -->
    <script>
      function parseCustomDate(dateString){
        const day = dateString.substring(0,2);
        const month = dateString.substring(2,4);
        const year = dateString.substring(4,8);

        const formattedDate = `${year}-${month}-${day}`;
        
        return formattedDate;
      }

      async function getRasiData() {
        
        const cachedData = localStorage.getItem('rasiData');
        const expiration = localStorage.getItem('rasiDataExpiration');

        console.log(expiration);

        if(cachedData && new Date(expiration) > Date.now()){
          console.log("usando datos de caché");
          return JSON.parse(cachedData);
        }

        console.log("haciendo llamado al backend");

        const response = await fetch('http://127.0.0.1:5000/api/amplitud/datos',{
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
        })
        const data = await response.json();

        localStorage.setItem('rasiData', JSON.stringify(data));
        const expirationDate = new Date();
        expirationDate.setHours(expirationDate.getHours() + 1);
        localStorage.setItem('rasiDataExpiration', expirationDate.toISOString());
        
        return data
      }
      
      async function showRasiData(params) {

        const spinner = document.getElementById("loading-spinner");
        const spinner2 = document.getElementById("loading-spinner2");
        const chartContainer = document.getElementById("apex3");

        spinner.style.display = "block";
        spinner2.style.display = "block";
        getRasiData().then(data => {
          
         let dates = data["dates"].map(parseCustomDate)
         let values = data["values"]
         const options = {
           chart: {type: "line", height: 350},
           series:[{name: "RASI", data: values}],
           xaxis: {
             categories : dates,
           },
           tickAmount:2
         };
         const chart = new ApexCharts(document.querySelector("#apex3"), options);
         const chart2 = new ApexCharts(document.querySelector("#ignore"), options);
        
         chartContainer.style.display = "block";

         chart.render();
         chart2.render();

         spinner.style.display = "none";
         spinner2.style.display = "none";
        })
        .catch(error => console.error('Error al obtener los datos:', error));
        
      
      }
      // .then(response => response.json())
      // .then
      

      document.addEventListener("DOMContentLoaded", showRasiData());
    </script>
    <script>
      

      function logout() {
        fetch("http://127.0.0.1:5000/api/auth/logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        }).then((res) => {
          if (res.status === 200) {
            res.json().then((data) => {
              addToast({
                type: "alert-success",
                title: "Ok",
                description: data["msg"],
              });
            });
            setTimeout(() => {
              window.location.href = "/";
            }, 1000);
          } else {
            res.json().then((data) => {
              addToast({
                type: "alert-danger",
                title: "Error",
                description: data["msg"],
              });
              return;
            });
          }
        });
      }
    </script>
    <!-- Javascripts -->
    <!-- <script src="plugins/jquery/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script> -->
    <!-- <script src="plugins/perfectscroll/perfect-scrollbar.min.js"></script> -->
    <!-- <script src="plugins/pace/pace.min.js"></script> -->
    <!-- <script src="plugins/sparkline/jquery.sparkline.min.js"></script> -->
    <!-- <script src="js/main.min.js"></script> -->
    <!-- <script src="../../assets/js/pages/dashboard.js"></script> -->
  </body>
</html>